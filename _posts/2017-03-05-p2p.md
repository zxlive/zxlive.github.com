---
layout: post
title:  "2年和10天，P2P打洞实验终于成功了"
date:   2017-03-05
categories: Working
author_name: 晓龙
author_url: /author/zxl
author_avatar: zxl
feature_image: succeed
---
电脑电信宽带和手机联通4G的点对点udp通讯终于打通了，一共花了10天时间。  
但其实这个关键技术，在2年多前就开始关注，尝试，却一直没有做出来。  
一直没有做出来的原因，是因为觉得太难，然后可能会由于Apple审核等风险，导致花的时间精力白费，不能赚钱。看了稻盛和夫的《京瓷哲学》，知道这其实是“自私自利”的行为，因为难度太大，而且担心不能赚钱就不去做。对我来说，这个观点真是醍醐灌顶。我一向以为自己不是一个自私的人，原来很多项目最终没做下去，都是因为自私的原因，太麻烦了，可能不赚钱，还是找轻松能保险来赚钱的项目来做吧，后果就是好多不错的产品都没有深度挖掘，毕竟太难了嘛。然后就去做那些所谓轻松的产品，做了2年后发现，这几个产品是做出来了，但并不像以前那样一炮而红，然后就不继续做了，首先选材都初衷就是自私的目的--“能不能赚钱”。  
但这次为什么花10天就把P2P打洞做出来了呢？  
稻盛和夫说的“私心了无”，目标不是自私自利时，才能克服各种困难，关键是我心态的变化，才能坚持把这个实验做成。  
难度在一开始就预见了，需要3端调试，一台服务器，两个手机，调试程序时，需要更新3个设备，头脑要考虑多设备多进程的时序，十分繁琐。用到了Go和Goroutine并发，涉及多线程和Channel的优雅关闭，也很麻烦。还需要专门的路由器做实验，还需要刷第三方的固件，然后买的第一台还有奇怪的问题，搞了半天才发现不是软件，是硬件故障。可谓困难重重。但这个时候的心态是铁了心要做出来，所以遇到这些困难一个个克服，也就不会像以前那样一遇到困难就停了下来。  

关键不是遇到的问题有多难，而是面对困难时的心态。  
我的心态是怎么样的呢？  
如果玩家能联机，那他玩游戏一定会很开心。就算Apple等审核政策的原因不让用VPN，我最终也要在我的游戏中使用这项技术，所以没有什么可以挡住我的，何况这项技术不仅仅是应用在这个产品中，其他摄像头，家电控制等领域都会用到这项技术。光考虑赚钱的话，一碰到困难就躲开了，毕竟还有很多轻松赚钱的办法。如果目的更加崇高，私心了无。不去考虑自己个人得失，只考虑这个任务的长远意义，就不会遇到困难就躲了。  

当心态变化积极面对困难的时候，还带来了一些意想不到的好处！ 

首先，网上关于P2P的文章都是理论文章，浮于表面，没有实际操作，都是一些书面文章。这类文章只会把简单问题复杂化，让困难显得更难。以前看了这些文章，看得越多，越不敢做，就好像面对的困难是座大山一样。然而，为了解决这个难题，我积极联系实际做过P2P的作者，抱着试一试的态度给作者写了一份邮件，询问P2P的实现逻辑。意外对方给了我答复，用很简单巧妙的方法就实现了80%的打洞成功率，根本就没用网上的那些麻烦复杂的方法。  
也就是说，积极面对困难的时候，困难反而变简单了，因为积极想办法，困难会一个个解决。
逃避困难的时候，难题好像会越积越大，就好像永远难于跨越一样。这可能与心理有关，逼到绝境，才会迸发出绝妙的解决方案。安逸的环境下只会产生笨拙的，理论上看起来好像正确的解决办法，拖延。  

XBOX账号已经提供了这个P2P联机功能，我还是不做了吧。这个是自私的理由。
XBOX的联机功能不好用，国内的孩子没有VPN根本连不上，而且还是基于熟人联机的，使用率太低了。我要开发的不一样，要更好玩。这个是利他的理由。  

其他的APP已经有联机功能了，我还是别做了吧。这也是自私的理由。
他们的联机功能还是不够好，问题多多。我还是要有自己的玩法，做得不一样。孩子们一定喜欢。何况，我还有更高的目标，不仅仅是联机。  

在到第10天，最初的激情有些降低了，我知道我有些累了，该做的实验迟迟没有动手，一直在做外围的准备工作，磨磨唧唧。这个时候，我给自己下了最后通牒，今天是打洞实验最后一天。如果实在不想做，就先换其他项目，等有了兴趣再换回来。  
不过，下了这个最后通牒后，反而轻松了下来，可能觉得那么麻烦的事情，也就剩下一天了，那就好好干吧。然后就把手机端的代码搭起来了，第一次联调实验确实和自己预期的一样，根本不通，原因也不清楚。  
然后，就找各种可能性一一排除。  
还突发奇想，找来另外一台笔记本电脑，用一个udp的app直接手动做打洞实验，然后就打通了，这个时候信心倍增，很快就在晚上把整个app的p2p通讯成功搞定了。  